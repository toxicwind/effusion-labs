#!/usr/bin/env bash
# Repo-local npm shim: inject keepalive for npm test invocations.
set -euo pipefail
orig_args=("$@")

if [[ "${LLM_HIJACK_DISABLE:-}" != "1" ]]; then
  if [[ "${1:-}" == "test" ]] || { [[ "${1:-}" == "run" ]] && [[ "${2:-}" == test* ]]; }; then
    extras="--import=./test/setup/http.mjs --import=./test/setup/llm-keepalive.mjs"
    export NODE_OPTIONS="${NODE_OPTIONS:-} ${extras}"
  fi
fi

shim_dir="$(cd "$(dirname "$0")" && pwd)"
IFS=':' read -r -a path_parts <<< "$PATH"
real=""
for d in "${path_parts[@]}"; do
  [[ "$d" == "$shim_dir" ]] && continue
  if [[ -x "$d/npm" ]]; then
    real="$d/npm"
    break
  fi
done
exec "${real:-/usr/bin/npm}" "${orig_args[@]}"
