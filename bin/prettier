#!/usr/bin/env bash
set -euo pipefail
. "$(cd "$(dirname "$0")" && pwd)/_lib.sh"

ensure_local_prettier() {
  local bin_local="$REPO_ROOT/node_modules/.bin/prettier"
  if [[ -x "$bin_local" ]]; then
    return 0
  fi

  if command -v npm >/dev/null 2>&1; then
    echo "📦 Installing prettier (devDependency)..." >&2
    npm install --save-dev --save-exact prettier@3 >/dev/null 2>&1 || true
  fi
}

ensure_local_prettier

retry_exec "$@" -- \
  "$REPO_ROOT/node_modules/.bin/prettier" \
  "$TOOLS_DIR/prettier/prettier" \
  prettier

echo "❌ prettier not available and local install failed. Ensure npm is usable or preinstall devDeps." >&2
exit 127
