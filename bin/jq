#!/usr/bin/env bash
set -euo pipefail
. "$(cd "$(dirname "$0")" && pwd)/_lib.sh"

retry_exec "$@" -- \
  "$REPO_ROOT/node_modules/.bin/jq" \
  "$TOOLS_DIR/jq/jq" \
  jq

if [[ ! -x "$TOOLS_DIR/jq/jq" ]]; then
  mkdir -p "$TOOLS_DIR/jq"
  url="https://github.com/jqlang/jq/releases/latest/download/jq-linux-amd64"
  echo "⬇️  Downloading jq static build..." >&2
  curl -fsSL "$url" -o "$TOOLS_DIR/jq/jq" && chmod +x "$TOOLS_DIR/jq/jq"
fi

retry_exec "$@" -- \
  "$REPO_ROOT/node_modules/.bin/jq" \
  "$TOOLS_DIR/jq/jq" \
  jq

echo "❌ jq not available; ensure devDeps installed." >&2
exit 127
