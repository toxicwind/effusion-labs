#!/usr/bin/env bash
set -euo pipefail
. "$(cd "$(dirname "$0")" && pwd)/_lib.sh"

retry_exec "$@" -- \
  "$REPO_ROOT/node_modules/.bin/yq" \
  "$TOOLS_DIR/yq/yq" \
  yq

if [[ ! -x "$TOOLS_DIR/yq/yq" ]]; then
  mkdir -p "$TOOLS_DIR/yq"
  url="https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64"
  echo "⬇️  Downloading yq static build..." >&2
  curl -fsSL "$url" -o "$TOOLS_DIR/yq/yq" && chmod +x "$TOOLS_DIR/yq/yq"
fi

retry_exec "$@" -- \
  "$REPO_ROOT/node_modules/.bin/yq" \
  "$TOOLS_DIR/yq/yq"

echo "❌ yq not available; ensure devDeps installed." >&2
exit 127
