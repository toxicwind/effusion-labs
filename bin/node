#!/usr/bin/env bash
# Repo-local node shim: inject keepalive only for direct node --test invocations.
set -euo pipefail

shim_dir="$(cd "$(dirname "$0")" && pwd)"
repo_root="$(cd "$shim_dir/.." && pwd)"
source "$repo_root/scripts/llm-constants.sh"

if [[ "${LLM_HIJACK_DISABLE:-}" != "1" ]] && [[ "${LLM_KEEPALIVE_INJECTED:-}" != "1" ]]; then
  for arg in "$@"; do
    if [[ "$arg" == "--test" ]]; then
      export NODE_OPTIONS="${NODE_OPTIONS:-} ${LLM_KEEPALIVE_IMPORTS}"
      export LLM_KEEPALIVE_INJECTED=1
      break
    fi
  done
fi

IFS=':' read -r -a path_parts <<< "$PATH"
real=""
for d in "${path_parts[@]}"; do
  [[ "$d" == "$shim_dir" ]] && continue
  if [[ -x "$d/node" ]]; then
    real="$d/node"
    break
  fi
done
exec "${real:-/usr/bin/node}" "$@"
