#!/usr/bin/env bash
# sd shim — ensures sd binary availability with canonical fallback order.
set -euo pipefail
. "$(cd "$(dirname "$0")" && pwd)/_lib.sh"

if ! ensure_sd_tool; then
  printf '%s\n' "sd-shim: warning: unable to provision sd automatically; falling back to system resolution." >&2
fi

PATH_WITHOUT_REPO_BIN="$(path_without_repo_bin)"
REAL_SD=""
if [[ -n "$PATH_WITHOUT_REPO_BIN" ]]; then
  REAL_SD="$(PATH="$PATH_WITHOUT_REPO_BIN" command -v sd 2>/dev/null || true)"
fi

candidates=(
  "$REPO_ROOT/node_modules/.bin/sd"
  "$TOOLS_DIR/sd/sd"
)
if [[ -n "$REAL_SD" ]]; then
  candidates+=("$REAL_SD")
fi
candidates+=(sd)

retry_exec "$@" -- "${candidates[@]}"

echo "❌ sd not available; install it or provide a system binary." >&2
exit 127
