# â”€â”€â”€ Build stage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FROM node:20-alpine AS builder

WORKDIR /app

# Log: node version and env context
RUN node -v && npm -v && echo "ğŸ³ STARTING ELEVENTY BUILD CONTEXT"

# Install deps
COPY package*.json ./
RUN npm ci

# Copy project files
COPY . .

# Show incoming directory structure
RUN echo "ğŸ“ Initial file tree:" && find . -type f

# Run Eleventy build (with Tailwind plugin)
RUN echo "âš™ï¸ Building site with Eleventy..." \
 && npx @11ty/eleventy

# Log final structure of _site
RUN echo "ğŸ“ _site structure:" && find _site -type f

# Check if main.css exists, preview contents
RUN echo "ğŸ” Inspecting _site/assets/main.css" \
 && if [ -f /app/_site/assets/main.css ]; then \
      ls -lh /app/_site/assets/main.css && \
      head -c 500 /app/_site/assets/main.css | strings || true; \
    else \
      echo "âš ï¸ WARNING: main.css NOT FOUND!"; \
    fi

# Optional: List logo presence
RUN echo "ğŸ–¼ï¸ Checking logo.png..." \
 && if [ -f /app/_site/assets/logo.png ]; then \
      ls -lh /app/_site/assets/logo.png; \
    else \
      echo "âš ï¸ WARNING: logo.png not found."; \
    fi

# â”€â”€â”€ Runtime stage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FROM nginx:stable-alpine

COPY --from=builder /app/_site/ /usr/share/nginx/html/
COPY .portainer/nginx.conf /etc/nginx/conf.d/default.conf
