{# components/products/ProvenanceList.njk #}
{# Usage:
   {{ provenanceList(provenanceSources(product.data.provenance_ref), { limit: 10, fx: build.fx, base: build.base_currency }) }}
#}
{% macro provenanceList(sources, opts = {}) %}
{% if sources and (sources | length) %}
  {% set base = (opts.base or (build and build.base_currency) or 'USD') | upper %}
  {% set fx   = opts.fx or (build and build.fx) or {} %}
  {% set limit = opts.limit or (sources | length) %}

  <ul class="provenance-list not-prose space-y-2" data-testid="provenance">
    {% for s in sources | slice(0, limit) %}
      {% set host = (s.url and (s.url | hostname)) or 'source' %}
      {% set title = s.title or host %}
      {% set cur = (s.currency or base) | upper %}

      {# price or midpoint #}
      {% set price = null %}
      {% if s.price is defined and s.price != null %}
        {% set price = s.price * 1 %}
      {% elseif s.price_min is defined and s.price_max is defined and s.price_min != null and s.price_max != null %}
        {% set price = ((s.price_min * 1) + (s.price_max * 1)) / 2 %}
      {% endif %}

      {# conversion #}
      {% set rate = null %}
      {% if cur == base %}
        {% set rate = 1 %}
      {% elseif fx and fx[cur] %}
        {% set rate = fx[cur] * 1 %}
      {% endif %}
      {% set conv = null %}
      {% if price != null and rate != null %}
        {% set conv = price * rate %}
      {% endif %}

      <li class="rounded-box border-2 border-black bg-base-100 p-3 sm:p-4 shadow-[4px_4px_0_rgba(0,0,0,0.85)]">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            {% if s.url %}
              <a href="{{ s.url }}" class="link link-hover font-medium break-words">{{ title }}</a>
            {% else %}
              <span class="font-medium">{{ title }}</span>
            {% endif %}
            <div class="mt-1 text-xs flex flex-wrap items-center gap-x-2 gap-y-1 opacity-80">
              <span class="badge badge-ghost badge-xs">{{ host }}</span>
              {% if s.market %}<span class="badge badge-outline badge-xs">{{ s.market }}</span>{% endif %}
              {% if s.retrieved_at %}<time datetime="{{ s.retrieved_at }}">{{ s.retrieved_at | humanDate | safe }}</time>{% endif %}
            </div>
          </div>

          <div class="text-right whitespace-nowrap">
            {% if price != null %}
              <div class="font-semibold">{{ price | money(cur) }}</div>
            {% else %}
              <div class="opacity-50">—</div>
            {% endif %}
            {% if conv != null and cur != base %}
              <div class="text-xs opacity-80">≈ {{ conv | money(base) }}</div>
            {% endif %}
          </div>
        </div>
      </li>
    {% endfor %}
  </ul>

  {% if (sources | length) > limit %}
    <details class="mt-3">
      <summary class="cursor-pointer">Show {{ (sources | length) - limit }} more source(s)</summary>
      <ul class="mt-2 space-y-2">
        {% for s in sources | slice(limit, (sources | length) - limit) %}
          <li class="text-sm">
            {% if s.url %}<a class="link link-hover" href="{{ s.url }}">{{ s.title or (s.url | hostname) }}</a>{% else %}{{ s.title or 'source' }}{% endif %}
          </li>
        {% endfor %}
      </ul>
    </details>
  {% endif %}
{% endif %}
{% endmacro %}