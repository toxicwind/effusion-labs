{# ---------------------------------------------------------------------------
 # Pretty spec sheet (Tailwind + daisyUI), MSCHF-ish accents
 # - No JS-style ternaries (Nunjucks-safe)
 # - Uses |length, explicit {% if %} blocks, and filter parentheses
 # - Works with your filters: titleizeSlug, humanDate, yesNo
 # --------------------------------------------------------------------------- #}
{% macro specSheet(product) %}
{% set p = product.data %}
{% set releaseDate = p.release_date or (p.release_info and p.release_info.release_date) %}
{% set editionKind = (p.edition and p.edition.kind) %}
{% set editionSize = (p.release_info and p.release_info.edition_size) or (p.availability and p.availability.unit_count) %}
{% set msrpMap  = (p.pricing and p.pricing.original_msrp) %}
{% set secRange = (p.pricing and p.pricing.secondary_market_range) %}
{% set availabilityIsLimited = (p.availability and p.availability.limited) %}

{# primaryMarket without ternary #}
{% if p.market_listings and (p.market_listings | length) %}
  {% set primaryMarket = p.market_listings[0] %}
{% else %}
  {% set primaryMarket = null %}
{% endif %}

<section
  class="card bg-base-100 border border-base-300/60 shadow-xl rounded-2xl overflow-hidden
         before:pointer-events-none before:block before:absolute before:inset-0
         before:bg-[radial-gradient(1200px_600px_at_0%_-10%,theme(colors.error/10),transparent_40%)]
         after:pointer-events-none after:block after:absolute after:inset-0
         after:bg-[radial-gradient(900px_500px_at_110%_120%,theme(colors.primary/10),transparent_40%)] relative">

  <div class="card-body gap-4">
    {# ---------- Header ---------- #}
    <div class="flex items-start justify-between gap-3">
      <div>
        <h2 class="card-title text-2xl sm:text-3xl tracking-tight">
          {{ p.product_title
             or (p.series and (p.series ~ ' • ' ~ (p.variant or '')))
             or p.title
             or 'Untitled Product' }}
        </h2>

        <div class="mt-2 flex flex-wrap items-center gap-2">
          {% if p.brand %}<span class="badge badge-outline">{{ p.brand | titleizeSlug }}</span>{% endif %}
          {% if p.line %}<span class="badge badge-outline">{{ p.line | titleizeSlug }}</span>{% endif %}
          {% if p.character %}
            <a class="badge badge-ghost hover:badge-outline transition"
               href="/archives/collectables/designer-toys/pop-mart/the-monsters/characters/{{ p.character }}/">
              {{ p.character | titleizeSlug }}
            </a>
          {% endif %}
          {% if p.series %}<span class="badge badge-ghost">{{ p.series | titleizeSlug }}</span>{% endif %}
          {% if p.form %}<span class="badge badge-ghost">{{ p.form | titleizeSlug }}</span>{% endif %}
        </div>
      </div>

      {# Availability chip (no ternary) #}
      {% set availBadge = 'badge-success' %}
      {% if availabilityIsLimited %}{% set availBadge = 'badge-error' %}{% endif %}
      <div class="tooltip tooltip-left" data-tip="Availability">
        <span class="badge {{ availBadge }} badge-lg">
          {{ availabilityIsLimited and 'Limited' or 'Standard' }}
        </span>
      </div>
    </div>

    {# ---------- Quick stats row ---------- #}
    <div class="stats stats-vertical sm:stats-horizontal w-full bg-base-200/40 rounded-xl border border-base-300/50">
      <div class="stat">
        <div class="stat-title opacity-70">Release</div>
        <div class="stat-value text-xl">
          {% if releaseDate %}
            {{ releaseDate | humanDate | safe }}
          {% else %}
            TBD
          {% endif %}
        </div>
        {% if p.size and (p.size.h or p.size.w or p.size.d) %}
          <div class="stat-desc">
            {{ p.size.h }}
            {% if p.size.w %}×{{ p.size.w }}{% endif %}
            {% if p.size.d %}×{{ p.size.d }}{% endif %}
            {{ p.size.unit or 'cm' }}
          </div>
        {% endif %}
      </div>

      <div class="stat">
        <div class="stat-title opacity-70">MSRP</div>
        <div class="stat-value text-xl">
          {% if primaryMarket and primaryMarket.price %}
            {{ primaryMarket.currency }} {{ primaryMarket.price }}
          {% elseif msrpMap %}
            {% for ccy, amt in msrpMap %}
              {% if loop.first %}
                {{ ccy }} {{ amt }}
              {% endif %}
            {% endfor %}
          {% else %}—{% endif %}
        </div>
        {% if secRange %}
          <div class="stat-desc">
            {% for ccy, rng in secRange %}
              {% if loop.first %}
                Secondary: {{ ccy }} {{ rng }}
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="stat">
        <div class="stat-title opacity-70">Region Lock</div>
        <div class="stat-value text-xl">{{ (p.distribution and p.distribution.region_lock) | yesNo }}</div>
        {% if p.distribution and p.distribution.markets and (p.distribution.markets | length) %}
          <div class="stat-desc flex flex-wrap gap-1">
            {% for m in p.distribution.markets %}
              <span class="badge badge-sm">{{ m }}</span>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>

    {# ---------- Spec sheet grid ---------- #}
    <dl data-testid="spec-sheet"
        class="grid grid-cols-1 sm:grid-cols-12 gap-x-6 gap-y-3 mt-4 text-sm leading-relaxed">

      {% if p.product_id %}
        <dt class="sm:col-span-3 text-base-content/70">Product ID</dt>
        <dd class="sm:col-span-9">
          <code class="kbd kbd-sm align-middle">{{ p.product_id }}</code>
          <button type="button"
                  class="btn btn-ghost btn-xs ml-2"
                  data-copy="{{ p.product_id }}"
                  aria-label="Copy product ID">
            Copy
          </button>
        </dd>
      {% endif %}

      {% if p.variant %}
        <dt class="sm:col-span-3 text-base-content/70">Variant</dt>
        <dd class="sm:col-span-9">{{ p.variant | titleizeSlug }}</dd>
      {% endif %}

      {% if editionKind %}
        <dt class="sm:col-span-3 text-base-content/70">Edition</dt>
        <dd class="sm:col-span-9">
          <span class="badge badge-outline">{{ editionKind | titleizeSlug }}</span>
          {% if editionSize %}<span class="badge badge-ghost ml-2">Size: {{ editionSize }}</span>{% endif %}
        </dd>
      {% endif %}

      {% if p.colorway %}
        <dt class="sm:col-span-3 text-base-content/70">Colorway</dt>
        <dd class="sm:col-span-9">{{ p.colorway | safe }}</dd>
      {% endif %}

      {% if p.articulation %}
        <dt class="sm:col-span-3 text-base-content/70">Articulation</dt>
        <dd class="sm:col-span-9">{{ p.articulation | safe }}</dd>
      {% endif %}

      {% if p.materials and (p.materials.shell or p.materials.plush or p.materials.stuffing) %}
        <dt class="sm:col-span-3 text-base-content/70">Materials</dt>
        <dd class="sm:col-span-9">
          <ul class="list-disc pl-5 space-y-1">
            {% if p.materials.shell %}<li><span class="opacity-70">Shell:</span> {{ p.materials.shell | safe }}</li>{% endif %}
            {% if p.materials.plush %}<li><span class="opacity-70">Plush:</span> {{ p.materials.plush | safe }}</li>{% endif %}
            {% if p.materials.stuffing %}<li><span class="opacity-70">Stuffing:</span> {{ p.materials.stuffing | safe }}</li>{% endif %}
          </ul>
        </dd>
      {% endif %}

      {% if p.packaging and (p.packaging.type or p.packaging.dimensions_cm) %}
        <dt class="sm:col-span-3 text-base-content/70">Packaging</dt>
        <dd class="sm:col-span-9">
          {% if p.packaging.type %}{{ p.packaging.type | safe }}{% endif %}
          {% if p.packaging.dimensions_cm %}<span class="opacity-70"> — {{ p.packaging.dimensions_cm | safe }}</span>{% endif %}
        </dd>
      {% endif %}

      {% if p.market_listings and (p.market_listings | length) %}
        <dt class="sm:col-span-3 text-base-content/70">Market Listings</dt>
        <dd class="sm:col-span-9">
          <ul class="flex flex-wrap gap-2">
            {% for l in p.market_listings %}
              <li class="tooltip" data-tip="{{ l.currency }} {{ l.price }}">
                <span class="badge badge-primary badge-outline">
                  {{ l.market }}{% if l.currency or l.price %} · {{ l.currency }} {{ l.price }}{% endif %}
                </span>
              </li>
            {% endfor %}
          </ul>
        </dd>
      {% endif %}

      {% if p.designer %}
        <dt class="sm:col-span-3 text-base-content/70">Designer</dt>
        <dd class="sm:col-span-9">{{ p.designer }}</dd>
      {% endif %}

      {% if p.accessories and (p.accessories | length) %}
        <dt class="sm:col-span-3 text-base-content/70">Accessories</dt>
        <dd class="sm:col-span-9">
          <ul class="list-disc pl-5 space-y-1">
            {% for a in p.accessories %}<li>{{ a | safe }}</li>{% endfor %}
          </ul>
        </dd>
      {% endif %}

      <dt class="sm:col-span-3 text-base-content/70">Region Lock</dt>
      <dd class="sm:col-span-9">{{ (p.distribution and p.distribution.region_lock) | yesNo }}</dd>

      {% if p.provenance_ref %}
        <dt class="sm:col-span-3 text-base-content/70">Provenance</dt>
        <dd class="sm:col-span-9">
          <a class="link link-primary" href="{{ p.provenance_ref }}">{{ p.provenance_ref | safe }}</a>
        </dd>
      {% endif %}

      {% if p.confidence is defined %}
        {% set confPct = (p.confidence * 100) | round(0, 'floor') %}
        <dt class="sm:col-span-3 text-base-content/70">Confidence</dt>
        <dd class="sm:col-span-9">
          <progress class="progress progress-error w-56 align-middle mr-2" value="{{ confPct }}" max="100"></progress>
          <span class="opacity-70">{{ confPct }}%</span>
        </dd>
      {% endif %}

      {% if p.notes %}
        <dt class="sm:col-span-3 text-base-content/70">Notes</dt>
        <dd class="sm:col-span-9">{{ p.notes | safe }}</dd>
      {% endif %}
    </dl>

    {# ---------- Changes / Deltas ---------- #}
    {% if p.Deltas and (p.Deltas | length) %}
      <div class="mt-4">
        <div class="collapse collapse-arrow border border-base-300/60 bg-base-200/50 rounded-xl">
          <input type="checkbox" />
          <div class="collapse-title text-base font-medium">
            {{ p.Deltas | length }} change{% if (p.Deltas | length) > 1 %}s{% endif %} in this record
          </div>
          <div class="collapse-content">
            <ul class="timeline timeline-vertical">
              {% for d in p.Deltas %}
                <li>
                  <div class="timeline-start">{{ d.field }}</div>
                  <div class="timeline-middle">
                    <span class="badge badge-error badge-sm"></span>
                  </div>
                  <div class="timeline-end timeline-box prose prose-sm max-w-none">
                    <p class="m-0"><strong>{{ d.reason }}</strong></p>
                    {% if d.from or d.to %}
                      <pre class="m-0 mt-2 rounded-lg bg-base-300/60 p-3 overflow-x-auto"><code>from: {{ d.from | safe }}
to:   {{ d.to   | safe }}</code></pre>
                    {% endif %}
                  </div>
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
</section>
{% endmacro %}
