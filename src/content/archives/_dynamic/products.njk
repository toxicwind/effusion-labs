---
layout: base.njk
pagination:
  data: archiveCharactersEn
  size: 1
  alias: character
eleventyComputed:
  permalink: "/archives/character/{{ character.data.charSlug }}/snapshot/"
  title: "Market Snapshot — {{ (character.data.name or character.data.charSlug) }}"
  showTitle: false
---

{% from "components/back-link.njk" import backLink %}
{% from "components/tile.njk" import tile %}
{% from "components/products/MarketTable.njk"    import marketTable %}
{% from "components/products/ProvenanceList.njk" import provenanceList %}
{# Breadcrumbs #}
<nav class="breadcrumbs text-sm mb-3 overflow-x-auto whitespace-nowrap"
     aria-label="Breadcrumb">
  <ul>
    <li>
      <a href="{{ '/archives/' | url }}">Archives</a>
    </li>
    <li>
      {% if character.data.companySlug %}
        <a href="{{ '/archives/collectables/designer-toys/' | url ~ character.data.companySlug ~ '/' }}">
          {{ (character.data.companyTitle or character.data.companySlug) | title }}
        </a>
      {% else %}
        Company
      {% endif %}
    </li>
    <li>
      {% if character.data.companySlug and character.data.lineSlug %}
        <a href="{{ '/archives/collectables/designer-toys/' | url ~ character.data.companySlug ~ '/' ~ character.data.lineSlug ~ '/' }}">
          {{ (character.data.lineTitle or character.data.lineSlug) | title }}
        </a>
      {% else %}
        Line
      {% endif %}
    </li>
    <li>
      <a href="{{ '/archives/character/' | url ~ character.data.charSlug ~ '/' }}">
        {{ character.data.name or character.data.charSlug }}
      </a>
    </li>
    <li class="opacity-70">Snapshot</li>
  </ul>
</nav>
<div class="mb-6">{{ backLink('Back to character', '/archives/character/' ~ character.data.charSlug ~ '/') }}</div>
{# Header #}
<section class="rounded-box border-2 border-black bg-base-200 p-5 sm:p-7 shadow-[6px_6px_0_rgba(0,0,0,0.85)]">
  <h1 class="m-0 font-extrabold tracking-tight fluid-title">
    Market Snapshot — {{ character.data.name or character.data.charSlug }}
  </h1>
  <p class="opacity-85 mt-2">
    {{ (character.data.companyTitle or character.data.companySlug) | title }}
    {% if character.data.companyTitle or character.data.companySlug %}·{% endif %}
    {{ (character.data.lineTitle or character.data.lineSlug) | title }}
  </p>
  {% if character.data.bio %}<p class="mt-2 opacity-80">{{ character.data.bio }}</p>{% endif %}
</section>
{# Select products in same company+line featuring this character #}
{% set inLine = collections.archiveProducts
  | byCompany(character.data.companySlug)
| byLine(character.data.lineSlug) %}
{% set products = [] %}
{% for p in inLine %}
  {% if p.data.charSlug and character.data.charSlug and p.data.charSlug == character.data.charSlug %}
    {% set products = products | push(p) %}
  {% endif %}
{% endfor %}
{# Aggregate listings across those products #}
{% set listingsAgg = [] %}
{% for p in products %}
  {% if p.data.market_listings and (p.data.market_listings | length) %}
    {% for l in p.data.market_listings %}
      {% set label = p.data.product_id or p.data.title or p.data.productSlug %}
      {% set listingsAgg = listingsAgg | push({
              "market": l.market,
              "url": l.url,
              "currency": l.currency,
              "price": l.price,
              "price_min": l.price_min,
              "price_max": l.price_max,
              "note": label
            }) %}
    {% endfor %}
  {% endif %}
{% endfor %}
{# Market snapshot table #}
{% if listingsAgg and (listingsAgg | length) %}
  <section class="card bg-base-100 border shadow-sm mt-6">
    <div class="card-body p-4 sm:p-6">
      <h2 class="text-lg font-semibold mb-3">Market snapshot</h2>
      {{ marketTable(listingsAgg, {
            fx:   (build and build.fx) or {},
      base: (build and build.base_currency) or 'USD',
      asOf: (build and build.fx_asof)
      }) }}
    </div>
  </section>
{% endif %}
{# Character-level provenance (optional) #}
{% if character.data.provenance_ref %}
  {% set provSources = character.data.provenance_ref | provenanceSources %}
  {% if provSources and (provSources | length) %}
    <section class="card bg-base-100 border shadow-sm mt-6">
      <div class="card-body p-4 sm:p-6">
        <h2 class="text-lg font-semibold mb-3">Provenance</h2>
        {{ provenanceList(provSources, {
                limit: 10,
                fx:   (build and build.fx) or {},
        base: (build and build.base_currency) or 'USD'
        }) }}
        <div class="mt-2 text-xs opacity-90 space-x-3">
          <a class="link link-hover"
             href="{{ character.data.provenance_ref | provenanceViewerUrl }}">View .jsonl</a>
          <a class="link"
             href="{{ character.data.provenance_ref | provenanceDownloadUrl }}"
             download>Download</a>
          {% if (provSources | length) > 10 %}
            <span class="opacity-60">· showing 10 of {{ provSources | length }}</span>
          {% endif %}
        </div>
      </div>
    </section>
  {% endif %}
{% endif %}
{# Product tiles (nice to keep here too) #}
{% if products and (products | length) %}
  <h2 class="text-lg font-semibold mt-8 mb-3">Products featuring this character</h2>
  <ul class="grid gap-4 sm:grid-cols-2 xl:grid-cols-3">
    {% for p in products %}<li>{{ tile(p) }}</li>{% endfor %}
  </ul>
{% else %}
  <p class="opacity-75 mt-6">No products indexed yet for this character.</p>
{% endif %}
