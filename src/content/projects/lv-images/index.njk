{% set totals = datasetMeta and datasetMeta.totals or {} %}
{% set totalsFmt = totalsFormatted or {} %}

{% if not datasetAvailable %}
<div class="alert alert-warning shadow-lg mb-6">
  <div>
    <span class="font-semibold">Dataset missing.</span>
    <span>Run <code>npm run lv-images:update</code> to scrape the Louis Vuitton image sitemaps and regenerate the viewer.</span>
  </div>
</div>
{% endif %}

<section
  class="space-y-6 mt-6"
  data-lv-images
  {% if dataJsonUrl %}data-json-url="{{ dataJsonUrl | url }}"{% endif %}
  data-meta-id="lv-images-meta"
>
  <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
    <article class="card hb-tile">
      <div class="card-body">
        <h2 class="card-title text-base font-semibold">Images scraped</h2>
        <p class="text-3xl font-extrabold">{{ totalsFmt.images or '0' }}</p>
        <p class="opacity-70 text-sm">Across {{ totalsFmt.localeCount or '0' }} locales</p>
      </div>
    </article>
    <article class="card hb-tile">
      <div class="card-body">
        <h2 class="card-title text-base font-semibold">Unique product pages</h2>
        <p class="text-3xl font-extrabold">{{ totalsFmt.pages or '0' }}</p>
        <p class="opacity-70 text-sm">{{ totalsFmt.hostCount or '0' }} hostnames observed</p>
      </div>
    </article>
    <article class="card hb-tile">
      <div class="card-body">
        <h2 class="card-title text-base font-semibold">Sitemaps processed</h2>
        <p class="text-3xl font-extrabold">{{ totalsFmt.sitemaps or '0' }}</p>
        <p class="opacity-70 text-sm">{{ totalsFmt.ok or '0' }} healthy · {{ totalsFmt.failures or '0' }} failures</p>
      </div>
    </article>
    <article class="card hb-tile">
      <div class="card-body">
        <h2 class="card-title text-base font-semibold">Last generated</h2>
        {% if datasetMeta %}
        <p class="text-lg font-semibold">{{ datasetMeta.generatedAt | date('yyyy-LL-dd HH:mm') }}</p>
        <p class="opacity-70 text-sm">UTC</p>
        {% else %}
        <p class="opacity-60">—</p>
        {% endif %}
      </div>
    </article>
  </div>

  <div class="card hb-tile">
    <div class="card-body space-y-4">
      <div class="flex flex-col xl:flex-row gap-4 xl:items-end">
        <label class="form-control w-full">
          <span class="label-text font-semibold">Search</span>
          <input data-role="search" type="search" placeholder="Title, image URL, page URL, locale, host…" class="input input-bordered" />
        </label>
        <div class="flex flex-wrap gap-3">
          <label class="form-control">
            <span class="label-text font-semibold">View</span>
            <select data-role="view" class="select select-bordered">
              <option value="unique" selected>Unique images (deduped)</option>
              <option value="all">All entries (raw)</option>
            </select>
          </label>
          <label class="form-control">
            <span class="label-text font-semibold">Dedup mode</span>
            <select data-role="dedupe" class="select select-bordered">
              <option value="originless" selected>Strip host + ?query</option>
              <option value="url">Strip ?query</option>
              <option value="exact">Exact URL</option>
            </select>
          </label>
          <label class="form-control">
            <span class="label-text font-semibold">Sort</span>
            <select data-role="sort" class="select select-bordered">
              <option value="loc-desc" selected>Locale coverage (↓)</option>
              <option value="host-desc">Host coverage (↓)</option>
              <option value="title-asc">Title A→Z</option>
              <option value="title-desc">Title Z→A</option>
              <option value="page-asc">Page URL A→Z</option>
              <option value="page-desc">Page URL Z→A</option>
              <option value="img-asc">Image URL A→Z</option>
              <option value="img-desc">Image URL Z→A</option>
            </select>
          </label>
        </div>
        <div class="flex flex-wrap gap-4">
          <label class="form-control w-48">
            <span class="label-text font-semibold flex items-center justify-between">
              Grid
              <span data-role="grid-readout" class="badge badge-neutral">240px</span>
            </span>
            <input data-role="grid-slider" type="range" min="180" max="360" value="240" class="range range-sm" />
          </label>
          <label class="form-control w-48">
            <span class="label-text font-semibold flex items-center justify-between">
              Batch
              <span data-role="batch-readout" class="badge badge-neutral">60</span>
            </span>
            <input data-role="batch-slider" type="range" min="24" max="144" value="60" class="range range-sm" />
          </label>
        </div>
        <div class="flex gap-2 flex-wrap">
          <button data-role="reset" class="btn btn-outline">Reset</button>
          <button data-role="export" class="btn btn-primary">Export view</button>
        </div>
      </div>

      <div class="grid gap-3 md:grid-cols-2 xl:grid-cols-4">
        <div class="stat bg-base-200 rounded-box">
          <div class="stat-title">Raw entries</div>
          <div class="stat-value text-2xl" data-role="stat-entries">{{ totalsFmt.images or '0' }}</div>
        </div>
        <div class="stat bg-base-200 rounded-box">
          <div class="stat-title">Unique (current view)</div>
          <div class="stat-value text-2xl" data-role="stat-unique">—</div>
        </div>
        <div class="stat bg-base-200 rounded-box">
          <div class="stat-title">Dupe groups</div>
          <div class="stat-value text-2xl" data-role="stat-dupes">—</div>
        </div>
        <div class="stat bg-base-200 rounded-box">
          <div class="stat-title">Active filters</div>
          <div class="stat-value text-2xl" data-role="stat-filters">0</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card hb-tile" id="lv-filters">
    <div class="card-body space-y-4">
      <h2 class="card-title text-base font-semibold">Facets</h2>
      <div class="grid gap-4 md:grid-cols-2">
        <div>
          <h3 class="font-semibold mb-2">Locales</h3>
          <div class="flex flex-wrap gap-2" data-role="facet-locales"></div>
        </div>
        <div>
          <h3 class="font-semibold mb-2">Hosts</h3>
          <div class="flex flex-wrap gap-2" data-role="facet-hosts"></div>
        </div>
      </div>
      <details class="collapse collapse-arrow bg-base-200">
        <summary class="collapse-title font-semibold">Source sitemaps{% if datasetMeta %} ({{ datasetMeta.sitemaps | length }}){% endif %}</summary>
        <div class="collapse-content text-sm leading-6 max-h-72 overflow-y-auto space-y-1">
          {% if datasetMeta %}
            {% for sitemap in datasetMeta.sitemaps %}
              <div class="flex flex-wrap items-center gap-2">
                <span class="badge badge-outline">{{ sitemap.locale }}</span>
                <span class="badge badge-outline">{{ sitemap.host }}</span>
                {% if sitemap.ok %}
                  <span class="badge badge-ghost">{{ sitemap.imageCount }} images</span>
                {% else %}
                  <span class="badge badge-error">Failed</span>
                {% endif %}
                <a class="link link-hover break-all" href="{{ sitemap.url }}" target="_blank" rel="noopener">{{ sitemap.url }}</a>
              </div>
            {% endfor %}
          {% else %}
            <p class="opacity-70">Dataset not generated yet.</p>
          {% endif %}
        </div>
      </details>

      <div class="grid gap-4 md:grid-cols-2">
        <div>
          <h3 class="font-semibold mb-2">Top locales</h3>
          <ul class="space-y-1 text-sm">
            {% for locale in topLocales %}
            <li class="flex justify-between border-b border-base-200 pb-1">
              <span>{{ locale.key }}</span>
              <span class="font-semibold">{{ locale.display }}</span>
            </li>
            {% endfor %}
            {% if not topLocales or topLocales | length == 0 %}
            <li class="opacity-60">No data yet.</li>
            {% endif %}
          </ul>
        </div>
        <div>
          <h3 class="font-semibold mb-2">Top hosts</h3>
          <ul class="space-y-1 text-sm">
            {% for host in topHosts %}
            <li class="flex justify-between border-b border-base-200 pb-1">
              <span class="break-words">{{ host.key }}</span>
              <span class="font-semibold">{{ host.display }}</span>
            </li>
            {% endfor %}
            {% if not topHosts or topHosts | length == 0 %}
            <li class="opacity-60">No data yet.</li>
            {% endif %}
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="card hb-tile">
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
        <h2 class="card-title text-base font-semibold">Gallery</h2>
        <div class="text-sm opacity-70" data-role="result-count">Waiting for dataset…</div>
      </div>
      <div class="min-h-[10rem]">
        <div class="grid-auto" data-role="grid" style="--tile-min:240px"></div>
        <div class="text-center text-base-content/60 py-8 hidden" data-role="empty">No results. Try clearing filters.</div>
        <div data-role="sentinel" class="h-8"></div>
      </div>
    </div>
  </div>
</section>

<dialog data-role="modal" class="modal">
  <div class="modal-box max-w-5xl" data-role="modal-box">
    <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button></form>
    <div data-role="modal-content" class="space-y-4"></div>
  </div>
  <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>

<script type="application/json" id="lv-images-meta">{{ datasetMeta | jsonify | safe }}</script>
<script type="module" src="{{ '/assets/js/lv-images.js' | url }}"></script>
