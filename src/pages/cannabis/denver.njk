---
layout: base.njk
title: Denver Cannabis Intelligence
permalink: /cannabis/denver/
eleventyNavigation:
  key: Denver Intel
  parent: Cannabis
  order: 1
---

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<div class="container mx-auto px-4 py-8" x-data="denverDashboard">
  <!-- Header -->
  <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
    <div>
       <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-500 hb-text-glow">Denver Intel</h1>
       <p class="text-gray-400 mt-2">Real-time dispensary tracking & price analysis</p>
    </div>
    
    <div class="flex gap-3">
       <button @click="view = 'map'" :class="view === 'map' ? 'bg-emerald-600' : 'bg-gray-800'" class="px-4 py-2 rounded-lg font-bold transition-all hover:scale-105">Map View</button>
       <button @click="view = 'grid'" :class="view === 'grid' ? 'bg-emerald-600' : 'bg-gray-800'" class="px-4 py-2 rounded-lg font-bold transition-all hover:scale-105">Deals Grid</button>
    </div>
  </div>

  <!-- Stats Row -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="hb-glass-card p-4 text-center">
          <div class="text-2xl font-bold text-emerald-400" x-text="dispensaries.length">0</div>
          <div class="text-xs text-gray-500 uppercase tracking-widest">Active Locations</div>
      </div>
       <div class="hb-glass-card p-4 text-center">
          <div class="text-2xl font-bold text-cyan-400">Loading...</div>
          <div class="text-xs text-gray-500 uppercase tracking-widest">Avg Ounce Price</div>
      </div>
  </div>

  <!-- Map Container -->
  <div x-show="view === 'map'" class="hb-glass-card p-1 rounded-2xl overflow-hidden h-[600px] relative z-0">
      <div id="denver-map" class="w-full h-full rounded-xl z-0"></div>
  </div>

  <!-- Deals Grid -->
  <div x-show="view === 'grid'" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <template x-for="disp in dispensaries" :key="disp.id">
          <div class="hb-glass-card p-6 hover:border-emerald-500/50 transition-colors group">
              <div class="flex justify-between items-start mb-4">
                  <h3 class="text-xl font-bold text-white group-hover:text-emerald-400 transition-colors" x-text="disp.name"></h3>
                  <span class="bg-emerald-900/50 text-emerald-300 text-xs px-2 py-1 rounded border border-emerald-500/30" x-text="disp.rating + ' ⭐'"></span>
              </div>
              <p class="text-gray-400 text-sm mb-4" x-text="disp.address"></p>
              
              <div class="flex justify-between items-center border-t border-white/10 pt-4 mt-4">
                  <div class="text-xs text-gray-500">
                      <span x-text="disp.products_count"></span> Products
                  </div>
                  <button class="text-emerald-400 text-sm font-bold hover:underline">View Menu →</button>
              </div>
          </div>
      </template>
  </div>

</div>

<script type="module">
  import { api } from '/assets/js/api-client.ts'
  import Alpine from 'alpinejs'

  document.addEventListener('alpine:init', () => {
    Alpine.data('denverDashboard', () => ({
      loading: true,
      view: 'map',
      dispensaries: [],
      map: null,

      async init() {
          try {
              this.dispensaries = await api.getDenverData()
              this.$nextTick(() => {
                  this.initMap()
              })
          } catch (e) {
              console.error("Failed to fetch Denver data", e)
          }
      },

      initMap() {
          if (this.view !== 'map') return; // Only init if visible, or handle resize
          
          // Denver coords
          const map = L.map('denver-map').setView([39.7392, -104.9903], 12);
          
          L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
          }).addTo(map);

          this.dispensaries.forEach(d => {
              const marker = L.marker([d.lat, d.lon])
                .bindPopup(`
                    <div style="font-family: sans-serif; color: #333">
                        <b>${d.name}</b><br>
                        ${d.address}<br>
                        Rating: ${d.rating}
                    </div>
                `)
                .addTo(map);
          })
          
          // Invalidate size to ensure render
          setTimeout(() => map.invalidateSize(), 500);
      }
    }))
  })
</script>
