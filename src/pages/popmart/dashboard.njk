---
layout: base.njk
title: Popmart Analytics
permalink: /popmart/dashboard/
eleventyNavigation:
  key: Analytics
  parent: Popmart
  order: 1
---

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container mx-auto px-4 py-8" x-data="popmartDashboard">
  <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
    <div>
        <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-500 hb-text-glow">Popmart Analytics</h1>
        <p class="text-gray-400 mt-2">Global stock tracking & drop prediction</p>
    </div>
    
    <button @click="triggerRecon" :disabled="scanning" class="px-6 py-2 bg-gradient-to-r from-pink-600 to-purple-600 rounded-lg font-bold hover:scale-105 transition-all flex items-center gap-2">
        <span x-show="scanning" class="animate-spin text-xl">↻</span>
        <span x-text="scanning ? 'Scanning...' : 'Trigger Recon'"></span>
    </button>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <!-- Total tracked -->
      <div class="hb-glass-card p-6 border-l-4 border-pink-500">
          <h3 class="text-gray-400 text-sm uppercase tracking-wider">Tracked SKUs</h3>
          <div class="text-4xl font-bold text-pink-400 mt-2">3,650</div>
          <div class="text-xs text-green-400 mt-1">↑ 12 new today</div>
      </div>
      
       <!-- Stock Out Rate -->
      <div class="hb-glass-card p-6 border-l-4 border-purple-500">
          <h3 class="text-gray-400 text-sm uppercase tracking-wider">Stock-Out Rate</h3>
          <div class="text-4xl font-bold text-purple-400 mt-2">18.4%</div>
          <div class="text-xs text-red-400 mt-1">↑ 2.1% vs yesterday</div>
      </div>
      
       <!-- Next Drop -->
      <div class="hb-glass-card p-6 border-l-4 border-blue-500">
          <h3 class="text-gray-400 text-sm uppercase tracking-wider">Next Predicted Drop</h3>
          <div class="text-2xl font-bold text-blue-400 mt-2">Friday, 10:00 AM</div>
          <div class="text-xs text-blue-300 mt-1">"Skullpanda" Series</div>
      </div>
  </div>

  <!-- Charts Row -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="hb-glass-card p-6">
          <h3 class="text-xl font-bold text-white mb-6">Stock Availability Trend</h3>
          <canvas id="stockChart"></canvas>
      </div>
       <div class="hb-glass-card p-6">
          <h3 class="text-xl font-bold text-white mb-6">Popular Series Heatmap</h3>
          <canvas id="seriesChart"></canvas>
      </div>
  </div>
  
  <!-- Recon Log -->
  <div class="hb-glass-card p-6">
      <h3 class="text-xl font-bold text-white mb-4">Recon Activity Log</h3>
      <div class="space-y-2 font-mono text-sm max-h-60 overflow-y-auto custom-scrollbar">
          <template x-for="log in logs" :key="log.time">
              <div class="flex gap-4 border-b border-white/5 py-2">
                  <span class="text-gray-500" x-text="log.time"></span>
                  <span :class="log.type === 'error' ? 'text-red-400' : 'text-emerald-400'" x-text="log.msg"></span>
              </div>
          </template>
      </div>
  </div>

</div>

<script type="module">
  import { api } from '/assets/js/api-client.ts'
  import Alpine from 'alpinejs'

  document.addEventListener('alpine:init', () => {
    Alpine.data('popmartDashboard', () => ({
      scanning: false,
      logs: [
          {time: '10:00:01', msg: 'Scheduled scan completed'},
          {time: '09:00:00', msg: 'System init'},
      ],

      async init() {
          this.initCharts();
      },
      
      async triggerRecon() {
          this.scanning = true;
          this.logs.unshift({time: new Date().toLocaleTimeString(), msg: 'Recon scan initiated...'});
          try {
              const res = await api.triggerPopmartRecon({id_start: 3600, id_end: 3620});
              this.logs.unshift({time: new Date().toLocaleTimeString(), msg: `Task started: ${res.task_id}`});
          } catch(e) {
              this.logs.unshift({time: new Date().toLocaleTimeString(), msg: 'Scan failed', type: 'error'});
          } finally {
              setTimeout(() => this.scanning = false, 2000);
          }
      },

      initCharts() {
          const ctx1 = document.getElementById('stockChart');
          new Chart(ctx1, {
            type: 'line',
            data: {
              labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
              datasets: [{
                label: 'In Stock Items',
                data: [3200, 3180, 3150, 3100, 3300, 3250, 3200],
                borderColor: '#c084fc',
                tension: 0.4,
                backgroundColor: 'rgba(192, 132, 252, 0.1)',
                fill: true
              }]
            },
            options: {
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { color: 'rgba(255,255,255,0.05)' } },
                    x: { grid: { color: 'rgba(255,255,255,0.05)' } }
                }
            }
          });
          
          const ctx2 = document.getElementById('seriesChart');
          new Chart(ctx2, {
            type: 'doughnut',
            data: {
              labels: ['Molly', 'Dimoo', 'Skullpanda', 'Labubu', 'Crybaby'],
              datasets: [{
                data: [30, 20, 25, 15, 10],
                backgroundColor: [
                  '#ec4899', '#c084fc', '#3b82f6', '#10b981', '#f59e0b'
                ],
                borderWidth: 0
              }]
            },
             options: {
                plugins: { legend: { position: 'right', labels: { color: '#fff' } } }
            }
          });
      }
    }))
  })
</script>
