name: "Interlinker CI"

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  interlinker:
    name: 🔗 Interlinker Guard
    runs-on: ubuntu-latest
    steps:
      - name: ⬇️ Checkout
        uses: actions/checkout@v4

      - name: 🟢 Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: 📦 Install deps
        run: |
          npm ci

      - name: 🧩 Verify interlinker patch applied
        run: node tools/verify-patch-applied.mjs

      - name: 🏗️ Build site (Eleventy)
        env:
          # Favor warning over failing by default in PRs
          INTERLINKER_MAX_UNRESOLVED: 200
          INTERLINKER_FAIL_ON_UNRESOLVED: false
          ELEVENTY_ENV: test
        run: |
          npx @11ty/eleventy

      - name: 🧾 Interlinker unresolved summary
        if: always()
        run: node tools/unresolved-summary.mjs >> "$GITHUB_STEP_SUMMARY"

      - name: 🚦 Optional: Fail on unresolved overflow
        if: always()
        env:
          INTERLINKER_MAX_UNRESOLVED: ${{ env.INTERLINKER_MAX_UNRESOLVED || 200 }}
          INTERLINKER_FAIL_ON_UNRESOLVED: ${{ env.INTERLINKER_FAIL_ON_UNRESOLVED || 'false' }}
        run: |
          # summarizeAndGate() runs in eleventy.after; rely on its exit code.
          echo "Interlinker gating controlled by env."

