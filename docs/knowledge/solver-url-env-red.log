npm warn Unknown env config "http-proxy". This will stop working in the next major version of npm.

> effusion_labs_final@1.0.0 test
> c8 --reporter=text-summary --reporter=lcov node tools/runner.mjs

[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/products/{{ p.data.product_id }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/characters/{{ c.data.slug }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[node-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[bracketed-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[11ty] Copied 77 Wrote 113 files in 5.25 seconds (46.4ms each, v3.1.2)
✔ archive nav exposes child counts (5270.916345ms)
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/products/{{ p.data.product_id }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/characters/{{ c.data.slug }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[node-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[bracketed-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[11ty] Copied 77 Wrote 113 files in 5.32 seconds (47.1ms each, v3.1.2)
✔ layout exposes build timestamp (5339.426728ms)
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/products/{{ p.data.product_id }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/characters/{{ c.data.slug }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[node-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[bracketed-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[11ty] Copied 77 Wrote 113 files in 4.63 seconds (41.0ms each, v3.1.2)
✔ code blocks expose copy control (4931.872066ms)
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/products/{{ p.data.product_id }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/characters/{{ c.data.slug }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[node-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[bracketed-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[11ty] Copied 77 Wrote 113 files in 5.35 seconds (47.3ms each, v3.1.2)
✔ collection pages expose section metadata (5366.545852ms)
✔ concept map JSON-LD export generates @context and @graph (5.430183ms)
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/products/{{ p.data.product_id }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/characters/{{ c.data.slug }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[node-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[bracketed-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[11ty] Copied 77 Wrote 113 files in 5.32 seconds (47.1ms each, v3.1.2)
✔ feed exposes build metadata (5343.221085ms)
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/products/{{ p.data.product_id }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/characters/{{ c.data.slug }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[node-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[bracketed-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[11ty] Copied 77 Wrote 113 files in 5.17 seconds (45.7ms each, v3.1.2)
✔ home page header includes primary nav landmark (5187.909657ms)
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/products/{{ p.data.product_id }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/characters/{{ c.data.slug }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[node-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[bracketed-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[11ty] Copied 77 Wrote 113 files in 4.49 seconds (39.8ms each, v3.1.2)
✔ homepage work list mixes types (4732.034683ms)
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/products/{{ p.data.product_id }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/characters/{{ c.data.slug }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[node-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[bracketed-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[11ty] Copied 77 Wrote 113 files in 4.69 seconds (41.5ms each, v3.1.2)
✔ homepage hero and work filters (4968.627396ms)
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/products/{{ p.data.product_id }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/characters/{{ c.data.slug }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[node-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[bracketed-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[11ty] Copied 77 Wrote 113 files in 5.37 seconds (47.5ms each, v3.1.2)
✔ markdown headings include anchor ids (5391.495785ms)
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/products/{{ p.data.product_id }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/characters/{{ c.data.slug }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[node-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[bracketed-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[11ty] Copied 77 Wrote 113 files in 5.44 seconds (48.1ms each, v3.1.2)
✔ monsters hub lists products and cross-links product and character pages (5458.904981ms)
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/products/{{ p.data.product_id }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/characters/{{ c.data.slug }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[node-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[bracketed-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[11ty] Copied 77 Wrote 113 files in 5.35 seconds (47.4ms each, v3.1.2)
✔ main nav marks current page and is labelled (5372.984336ms)
✔ navigation items are sequentially ordered (1.600766ms)
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/products/{{ p.data.product_id }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/characters/{{ c.data.slug }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[node-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[bracketed-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[11ty] Copied 77 Wrote 113 files in 5.33 seconds (47.2ms each, v3.1.2)
✔ buildLean sets env and output directory (5363.218671ms)
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/products/{{ p.data.product_id }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink (/archives/collectables/designer-toys/pop-mart/the-monsters/characters/{{ c.data.slug }}/) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[node-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[@photogabble/wikilinks] WARNING Wikilink ([[bracketed-handle]]) found pointing to to non-existent page in:
	- ./src/content/sparks/vapor-linked-governance.md
[11ty] Copied 77 Wrote 113 files in 4.84 seconds (42.8ms each, v3.1.2)
✔ spark listings reveal status text (4867.89313ms)
✔ deploy workflow does not trigger on pull_request (1.960858ms)
✔ build job runs only on push events (0.324703ms)
✔ defines improved background colors (4.837711ms)
✔ text contrast meets WCAG AA (1.346436ms)
✔ tailwind exposes readable fonts (0.246639ms)
✔ includes fluid type scale tokens (0.255585ms)
✔ docs:links reports no broken links (1673.44883ms)
✔ package-lock.json defines lockfileVersion (8.48995ms)
✔ projects computed picks latest entries by date (2.920392ms)
✔ keepalive emits heartbeat to stderr (6397.717958ms)
✔ keepalive ignores first SIGINT (446.691162ms)
✖ gateway reads SOLVER_URL from environment (3.086828ms)
✔ gateway retains default solver URL (0.235793ms)
✔ source link renders with arrow and class (21.230191ms)
✔ non-source link keeps text (2.57663ms)
✔ devDependencies omit @vscode/ripgrep (1.955189ms)
✔ prepare-docs avoids ripgrep install (0.229526ms)
✔ time to chill includes size with height in cm (2.01886ms)
✔ time to chill height is positive (0.197651ms)
✔ GitHub workflows use latest action versions (2.063424ms)
ℹ tests 35
ℹ suites 0
ℹ pass 34
ℹ fail 1
ℹ cancelled 0
ℹ skipped 0
ℹ todo 0
ℹ duration_ms 37845.439291

✖ failing tests:

test at test/unit/markdown-gateway-config.test.mjs:10:7
✖ gateway reads SOLVER_URL from environment (3.086828ms)
  AssertionError [ERR_ASSERTION]: The input did not match the regular expression /os\.environ\.get\(\"SOLVER_URL\"/. Input:
  
  'import os\n' +
    'from functools import wraps\n' +
    'from urllib.parse import urljoin\n' +
    '\n' +
    'import requests\n' +
    'from bs4 import BeautifulSoup\n' +
    'from flask import Flask, jsonify, request\n' +
    'from markdownify import markdownify\n' +
    'from readability import Document\n' +
    '\n' +
    'app = Flask(__name__)\n' +
    'API_KEY = os.environ.get("GATEWAY_API_KEY")\n' +
    'SOLVER_URL = "http://solver:8191/v1"\n' +
    '\n' +
    '\n' +
    'def require_api_key(func):\n' +
    '    @wraps(func)\n' +
    '    def wrapper(*args, **kwargs):\n' +
    '        if not API_KEY or request.headers.get("X-Api-Key") != API_KEY:\n' +
    '            return jsonify({"error": "unauthorized"}), 401\n' +
    '        return func(*args, **kwargs)\n' +
    '\n' +
    '    return wrapper\n' +
    '\n' +
    '\n' +
    '@app.route("/health", methods=["GET"])\n' +
    'def health():\n' +
    '    return jsonify({"status": "healthy"}), 200\n' +
    '\n' +
    '\n' +
    '@app.route("/convert", methods=["POST"])\n' +
    '@require_api_key\n' +
    'def convert():\n' +
    '    data = request.get_json(silent=True) or {}\n' +
    '    url = data.get("url")\n' +
    '    if not url:\n' +
    '        return jsonify({"error": "url is required"}), 400\n' +
    '\n' +
    '    payload = {"cmd": "request.get", "url": url}\n' +
    '    try:\n' +
    '        solver_resp = requests.post(SOLVER_URL, json=payload, timeout=120)\n' +
    '\n' +
    '        solver_resp.raise_for_status()\n' +
    '        body = solver_resp.json()\n' +
    '        if body.get("status") != "ok":\n' +
    '            return jsonify({"error": "solver error"}), 502\n' +
    '        html = body.get("solution", {}).get("response")\n' +
    '        if not html:\n' +
    '            return jsonify({"error": "empty response"}), 502\n' +
    '    except requests.RequestException as exc:\n' +
    '        return jsonify({"error": str(exc)}), 502\n' +
    '\n' +
    '    doc = Document(html)\n' +
    '    cleaned_html = doc.summary()\n' +
    '    soup = BeautifulSoup(cleaned_html, "lxml")\n' +
    '    for tag in soup.find_all(href=True):\n' +
    '        tag["href"] = urljoin(url, tag["href"])\n' +
    '    for tag in soup.find_all(src=True):\n' +
    '        tag["src"] = urljoin(url, tag["src"])\n' +
    '    markdown = markdownify(str(soup))\n' +
    '    return jsonify({"flareresolver": body, "markdown": markdown})\n' +
    '\n' +
    '\n' +
    'if __name__ == "__main__":\n' +
    '    app.run(host="0.0.0.0", port=5000)\n'
  
      at TestContext.<anonymous> (file:///workspace/effusion-labs/test/unit/markdown-gateway-config.test.mjs:11:10)
      at Test.runInAsyncScope (node:async_hooks:214:14)
      at Test.run (node:internal/test_runner/test:1047:25)
      at Test.start (node:internal/test_runner/test:944:17)
      at startSubtestAfterBootstrap (node:internal/test_runner/harness:296:17)
      at async file:///workspace/effusion-labs/test/unit/markdown-gateway-config.test.mjs:10:1 {
    generatedMessage: true,
    code: 'ERR_ASSERTION',
    actual: 'import os\nfrom functools import wraps\nfrom urllib.parse import urljoin\n\nimport requests\nfrom bs4 import BeautifulSoup\nfrom flask import Flask, jsonify, request\nfrom markdownify import markdownify\nfrom readability import Document\n\napp = Flask(__name__)\nAPI_KEY = os.environ.get("GATEWAY_API_KEY")\nSOLVER_URL = "http://solver:8191/v1"\n\n\ndef require_api_key(func):\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        if not API_KEY or request.headers.get("X-Api-Key") != API_KEY:\n            return jsonify({"error": "unauthorized"}), 401\n        return func(*args, **kwargs)\n\n    return wrapper\n\n\n@app.route("/health", methods=["GET"])\ndef health():\n    return jsonify({"status": "healthy"}), 200\n\n\n@app.route("/convert", methods=["POST"])\n@require_api_key\ndef convert():\n    data = request.get_json(silent=True) or {}\n    url = data.get("url")\n    if not url:\n        return jsonify({"error": "url is required"}), 400\n\n    payload = {"cmd": "request.get", "url": url}\n    try:\n        solver_resp = requests.post(SOLVER_URL, json=payload, timeout=120)\n\n        solver_resp.raise_for_status()\n        body = solver_resp.json()\n        if body.get("status") != "ok":\n            return jsonify({"error": "solver error"}), 502\n        html = body.get("solution", {}).get("response")\n        if not html:\n            return jsonify({"error": "empty response"}), 502\n    except requests.RequestException as exc:\n        return jsonify({"error": str(exc)}), 502\n\n    doc = Document(html)\n    cleaned_html = doc.summary()\n    soup = BeautifulSoup(cleaned_html, "lxml")\n    for tag in soup.find_all(href=True):\n        tag["href"] = urljoin(url, tag["href"])\n    for tag in soup.find_all(src=True):\n        tag["src"] = urljoin(url, tag["src"])\n    markdown = markdownify(str(soup))\n    return jsonify({"flareresolver": body, "markdown": markdown})\n\n\nif __name__ == "__main__":\n    app.run(host="0.0.0.0", port=5000)\n',
    expected: /os\.environ\.get\(\"SOLVER_URL\"/,
    operator: 'match'
  }
Executed 25 tests

=============================== Coverage summary ===============================
Statements   : 84.2% ( 1194/1418 )
Branches     : 78.9% ( 187/237 )
Functions    : 74.07% ( 60/81 )
Lines        : 84.2% ( 1194/1418 )
================================================================================
